[shop/tools/hidden] function(triggerId)
    local itemCat = "tools"
    setChatVar(triggerId, "category", itemCat)
    sysFunction(triggerId, "item.sys", "category", itemCat)
end!!

[shop/consumables/hidden] function(triggerId)
    local itemCat = "consumables"
    setChatVar(triggerId, "category", itemCat)
    sysFunction(triggerId, "item.sys", "category", itemCat)
end!!

[shop/traps/hidden] function(triggerId)
    local itemCat = "traps"
    setChatVar(triggerId, "category", itemCat)
    sysFunction(triggerId, "item.sys", "category", itemCat)
end!!

[shop/unlock/hidden] function(triggerId)
    local itemCat = "unlock"
    setChatVar(triggerId, "category", itemCat)
    sysFunction(triggerId, "item.sys", "category", itemCat)
end!!

[shop/plus/hidden] function(triggerId)
    local itemName = getChatVar(triggerId, "itemName")
    local itemCount = getChatVar(triggerId, "itemQuantity")
    local itemPrice = tonumber(getChatVar(triggerId, "itemPrice"))
    local inventory = json.decode(getChatVar(triggerId, "inventory"))
    local spirit = tonumber(getChatVar(triggerId, "spirit"))
    local maxCount = math.min(99 - (inventory[itemName] or 0), math.floor(spirit/itemPrice))

    local total_q = tonumber(inventory[itemName] or 0)
    if total_q >= 98 then
        alertNormal(triggerId, "구매가능한 수량을 초과했습니다.")
        return
    end

    itemCount = math.min(itemCount + 1, maxCount)
    setChatVar(triggerId, "itemQuantity", itemCount)
    setChatVar(triggerId, "itemTotalPrice", intForm(itemCount*itemPrice))
end!!

[shop/minus/hidden] function(triggerId)
    local itemCount = getChatVar(triggerId, "itemQuantity")
    local itemPrice = tonumber(getChatVar(triggerId, "itemPrice"))
    itemCount = math.max(itemCount - 1, 1)
    setChatVar(triggerId, "itemQuantity", itemCount)
    setChatVar(triggerId, "itemTotalPrice", intForm(itemCount*itemPrice))
end!!

[shop/quantity/hidden] function(triggerId)
    local itemName = getChatVar(triggerId, "itemName")
    local itemCount = getChatVar(triggerId, "itemQuantity")
    local itemPrice = tonumber(getChatVar(triggerId, "itemPrice"))
    local inventory = json.decode(getChatVar(triggerId, "inventory"))
    local spirit = tonumber(getChatVar(triggerId, "spirit"))
    local maxCount = math.min(99 - (inventory[itemName] or 0), math.floor(spirit/itemPrice))
    local quantity = alertInput(triggerId, "수량을 입력하세요.(1~"..maxCount..")"):await()
    quantity = tonumber(quantity)
    if tonumber(quantity) then
        itemCount = math.max(1, math.min(maxCount, quantity))
    else
        itemCount = 1
    end

    local total_q = tonumber(inventory[itemName] or 0)
    if itemCount+total_q >= 99 then
        alertNormal(triggerId, "구매가능한 수량을 초과했습니다.")
        return
    end

    setChatVar(triggerId, "itemQuantity", itemCount)
    setChatVar(triggerId, "itemTotalPrice", intForm(itemCount*itemPrice))
end!!

[shop/purchase/hidden] function(triggerId)
    local itemName = getChatVar(triggerId, "itemName")
    local itemKey = getChatVar(triggerId, "itemKey") or itemName -- 함정은 영문 키 사용
    if itemKey == "" then itemKey = itemName end
    local itemCount = getChatVar(triggerId, "itemQuantity")
    local itemTotalPrice = tonumber(getChatVar(triggerId, "itemTotalPrice"))
    local inventory = json.decode(getChatVar(triggerId, "inventory"))
    local spirit = tonumber(getChatVar(triggerId, "spirit"))
    local message = '<div class="purchased">'..itemName..' 구매완료!</div>'

    if itemTotalPrice > spirit then
        alertNormal(triggerId, "spirit이 부족합니다.")
        return
    end

    local total_q = tonumber(inventory[itemKey] or 0)
    if total_q >= 99 then
        alertNormal(triggerId, "구매가능한 수량을 초과했습니다.")
        return
    end

    spirit = spirit - itemTotalPrice
    inventory[itemKey] = tostring((inventory[itemKey] or 0)+itemCount)
    setChatVar(triggerId, "spirit", intForm(spirit))
    setChatVar(triggerId, "inventory", json.encode(inventory))
    local itemCat = getChatVar(triggerId, "category")
    sysFunction(triggerId, "item.sys", "category", itemCat)
    setChatVar(triggerId, "screenEffect", message)
    
    debug(string.format("[Item:Buy] Item: %s, Price: %d, Result: Success", itemKey, itemTotalPrice))
    
    setChatVar(triggerId, "itemKey", "") -- 초기화
end!!

/// tools 아이템 선택 핸들러
[shop/heart_stone/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "heart_stone")
end!!
[shop/honey_worm/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "honey_worm")
end!!
[shop/anal_worm/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "anal_worm")
end!!
[shop/anal_plug/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "anal_plug")
end!!
[shop/anal_beads/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "anal_beads")
end!!
[shop/blindfold/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "blindfold")
end!!
[shop/ball_gag/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "ball_gag")
end!!
[shop/ring_gag/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "ring_gag")
end!!
[shop/slime_snail/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "slime_snail")
end!!
[shop/milk_snail/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "milk_snail")
end!!
[shop/whip/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "whip")
end!!
[shop/rope/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "rope")
end!!
[shop/enema/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "enema")
end!!
[shop/collar/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "collar")
end!!

/// consumables 아이템 선택 핸들러
[shop/oil/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "oil")
end!!
[shop/crystal_ball/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "crystal_ball")
end!!
[shop/nutrient/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "nutrient")
end!!
[shop/incense/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "incense")
end!!
[shop/aphrodisiac/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "aphrodisiac")
end!!
[shop/dewormer/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "dewormer")
end!!
[shop/hair_tonic/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "hair_tonic")
end!!
[shop/ovulation_inducer/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "ovulation_inducer")
end!!

/// unlock 아이템 선택 핸들러
[shop/alchemy_knowledge/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "alchemy_knowledge")
end!!
[shop/demon_knowledge/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "demon_knowledge")
end!!
[shop/lewd_demon_knowledge/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "lewd_demon_knowledge")
end!!
[shop/forbidden_knowledge/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "forbidden_knowledge")
end!!

/// 함정 아이템 선택 핸들러
[shop/arrow_trap/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "arrow_trap")
end!!
[shop/poison_gas_trap/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "poison_gas_trap")
end!!
[shop/spike_pit/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "spike_pit")
end!!
[shop/fire_glyph/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "fire_glyph")
end!!
[shop/ice_floor_trap/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "ice_floor_trap")
end!!
[shop/shock_wire/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "shock_wire")
end!!
[shop/net_launcher/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "net_launcher")
end!!
[shop/sleep_mist/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "sleep_mist")
end!!
[shop/acid_spray/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "acid_spray")
end!!
[shop/blade_corridor/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "blade_corridor")
end!!
[shop/teleport_trap/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "teleport_trap")
end!!
[shop/darkness_trap/hidden] function(triggerId)
    sysFunction(triggerId, "item.sys", "select", "darkness_trap")
end!!

[shop/199/돌아가기] function(triggerId)
    setChatVar(triggerId, "itemName", "")
    setChatVar(triggerId, "itemKey", "")
    setChatVar(triggerId, "itemQuantity", 0)
    setChatVar(triggerId, "itemPrice", 0)
    setChatVar(triggerId, "itemTotalPrice", 0)
    setChatVar(triggerId, "itemDetail", "")
    setChatVar(triggerId, "category", "")
    setChatVar(triggerId, "category", "items")
    screenChange(triggerId, getState(triggerId, "oldScreen"))
end!!
