-- item.sys.txt
-- 아이템/상점 관리 통합 모듈
-- 사용법: sysFunction(triggerId, "item.sys", "select", itemKey)
--         sysFunction(triggerId, "item.sys", "category", itemCat)

(function()
    ---------------------------------------
    -- 디스패처 테이블 및 로컬 변수
    ---------------------------------------
    local funcs = {}

    ---------------------------------------
    -- 함수 정의
    ---------------------------------------

    -- 개별 아이템 선택 (상세정보 표시)
    function funcs.select(triggerId, itemKey)
        -- debug(string.format("[Item:Select] Key: %s", itemKey))
        setChatVar(triggerId, "itemKey", itemKey)
        setChatVar(triggerId, "itemQuantity", 1)

        -- trap.db에서 먼저 검색
        local trapDB = json.decode(getLoreBookContent(triggerId, "trap.db"))
        if trapDB[itemKey] then
            local trap = trapDB[itemKey]
            setChatVar(triggerId, "itemName", trap.name)
            setChatVar(triggerId, "itemPrice", intForm(trap.price))
            setChatVar(triggerId, "itemTotalPrice", intForm(trap.price))
            setChatVar(triggerId, "itemDetail", trap.desc)
            return
        end

        -- items.db에서 검색 (새 객체 구조)
        local items = json.decode(getLoreBookContent(triggerId, "items.db"))
        for _, category in pairs(items) do
            if category[itemKey] then
                local item = category[itemKey]
                setChatVar(triggerId, "itemName", item.name)
                setChatVar(triggerId, "itemPrice", intForm(item.price))
                setChatVar(triggerId, "itemTotalPrice", intForm(item.price))
                setChatVar(triggerId, "itemDetail", item.desc)
                return
            end
        end
    end

    -- 카테고리별 아이템 목록 생성
    function funcs.category(triggerId, itemCat)
        debug(string.format("[Item:Category] Switched to: %s", itemCat))
        local itemList
        local orderedKeys

        -- traps는 별도의 trap.db에서 로드
        if itemCat == "traps" then
            itemList = json.decode(getLoreBookContent(triggerId, "trap.db"))
            orderedKeys = json.decode(getChatVar(triggerId, "trapsList"))
        else
            itemList = json.decode(getLoreBookContent(triggerId, "items.db"))[itemCat]
            orderedKeys = json.decode(getChatVar(triggerId, itemCat .. "List"))
        end

        local contents = ""
        local inventory = json.decode(getChatVar(triggerId, "inventory"))

        -- 조합지식이 필요한 아이템 목록
        local needKnowl = {
            ["nutrient"] = true,
            ["diuretic"] = true,
            ["aphrodisiac"] = true,
            ["dewormer"] = true,
            ["hair_tonic"] = true
        }

        -- orderedKeys를 순회하여 itemList에서 정보를 가져옴
        for _, k in ipairs(orderedKeys) do
            local v = itemList[k]
            if v then
                local condition = true
                local reason = ""

                -- 새 객체 구조에서 필드 접근
                local itemName = v.name
                local itemPrice = v.price

                if k == "unlock2" and inventory["unlock1"] == "0" then
                    condition = false
                    reason = "조합지식 필요"
                elseif k == "unlock3" and inventory["unlock2"] == "0" then
                    condition = false
                    reason = "마족정보 필요"
                elseif k == "unlock4" and inventory["unlock3"] == "0" then
                    condition = false
                    reason = "음마지식 필요"
                elseif (itemCat == "tools" or itemCat == "unlock") and inventory[k] == "1" then
                    condition = false
                    reason = "이미 보유중"
                elseif tonumber(inventory[k] or 0) >= 99 then
                    condition = false
                    reason = "이미 최대로 보유중"
                elseif needKnowl[k] and inventory["unlock1"] == "0" then
                    condition = false
                    reason = "조합지식 필요"
                end

                if condition then
                    local price = intForm(itemPrice)
                    contents = contents ..
                        "<div class='shop-item btn' risu-btn='" ..
                        k ..
                        "'><div class='item-image'><img src='{{raw::" ..
                        itemName ..
                        ".png}}'></div><div class='item-info'><span class='item-name'>" ..
                        itemName .. "</span><span class='item-price'>" .. price .. " spirit</span></div></div>"
                end
            end
        end

        if contents == "" then
            contents =
            "<div class='shop-item btn'><div class='item-image'><img src='{{raw::empty.png}}'></div><div class='item-info'><span class='item-name'>모두 구매하였습니다.</span></div></div>"
        end

        setChatVar(triggerId, "tools", contents)
        setChatVar(triggerId, "itemName", "아이템을 선택하세요")
        setChatVar(triggerId, "itemQuantity", 0)
        setChatVar(triggerId, "itemTotalPrice", 0)
        setChatVar(triggerId, "itemDetail", "")
    end

    -- 아이템 소모
    function funcs.consume(triggerId, itemKey, quantity)
        quantity = quantity or 1
        local inventory = json.decode(getChatVar(triggerId, "inventory"))
        
        local current = tonumber(inventory[itemKey]) or 0
        if current < quantity then
            alertNormal(triggerId, "아이템이 부족합니다.")
            return false
        end

        inventory[itemKey] = tostring(max(0, current - quantity))
        setChatVar(triggerId, "inventory", json.encode(inventory))
        return true
    end

    ---------------------------------------
    -- 메인 함수 (외부에서 호출됨)
    ---------------------------------------
    return function(triggerId, subFunc, ...)
        if funcs[subFunc] then
            return funcs[subFunc](triggerId, ...)
        else
            debug("item.sys: 알 수 없는 함수 - " .. tostring(subFunc))
        end
    end
end)()
