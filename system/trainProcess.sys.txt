--ì¡°êµ ì»¤ë§¨ë“œì— ë”°ë¥¸ LLMì˜ ì¶œë ¥ì„ ì²˜ë¦¬
function(triggerId, dc, HP, SP, exps, feeling, command)
    debug("trainProcess ì‹¤í–‰")

    --[[ì´ˆê¸°í™”]]
    math.randomseed(os.time())
    local screenEffect = "" --screenEffect ì´ˆê¸°í™”

    --[[ë‚ ì§œê³„ì‚°]]
    local day = getChatVar(triggerId, "day")
    local ampm = tonumber(getChatVar(triggerId, "ampm"))
    local date = "day"..day
    if ampm == 0 then
        date = date.." â˜€ï¸ ë‚®"
    else
        date = date.." ğŸŒ™ ë°¤"
    end

    --[[DBí˜¸ì¶œ]]
    local EXPtbl = json.decode(getLoreBookContent(triggerId, "EXPtable.db"))
    local markDB = json.decode(getLoreBookContent(triggerId, "mark.db"))
    local ablDB = json.decode(getLoreBookContent(triggerId, "abl.db"))
    local traitDB = json.decode(getLoreBookContent(triggerId, "trait.db"))
    local statDB = json.decode(getLoreBookContent(triggerId, "stat.db"))
    local expDB = json.decode(getLoreBookContent(triggerId, "exp.db"))
    local itemDB = json.decode(getLoreBookContent(triggerId, "items.db"))
    --statdbì—ì„œ ì„¤ëª…íŒŒíŠ¸ë§Œ ì¶”ì¶œ
    for k,v in pairs(statDB) do
        statDB[k] = v[1]
    end

    --[[ìœ ì €ì™€ ì¡°êµëŒ€ìƒì˜ ì •ë³´ í˜¸ì¶œ]]
    local user = getLoreBookContent(triggerId, "user") --ìœ ì €ì˜ ì •ë³´ë¥¼ ë¡œì–´ë¶ì—ì„œ stringìœ¼ë¡œ í˜¸ì¶œ
    local target_c = getChatVar(triggerId, "target") --ëŒ€ìƒì •ë³´ë¥¼ chatvarì—ì„œ stringìœ¼ë¡œ í˜¸ì¶œ
    local target = getState(triggerId, "target") --ëŒ€ìƒì •ë³´ë¥¼ stateì—ì„œ í…Œì´ë¸”ë¡œ í˜¸ì¶œ
    local currentStat = getState(triggerId, "stat") --í˜„ì¬ statì„ í˜¸ì¶œ
    local equipments = getChatVar(triggerId, "equipments") --í˜„ì¬ ê°ì¢… ì¥ë¹„ì˜ ì°©ìš© ì—¬ë¶€ë¥¼ í˜¸ì¶œ
    local king = getChatVar(triggerId, "king") --ê´‘ì™•ì˜ ì •ë³´ í˜¸ì¶œ

    --[[ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì‘ë‹µì¤‘ í‘œì‹œ]]
    local old_cmds = getChatVar(triggerId, "cmds")
    local process_comment = "[stat ê³„ì‚°ì¤‘]"
    local loading_prepend = [[<div class="loading-container"><div class="loading-text">]]
    local loading_append = [[</div>
    <div class="loading-dots">
    <span class="dot-1"></span>
    <span class="dot-2"></span>
    <span class="dot-3"></span>
    </div>
    </div>]]
    setChatVar(triggerId, "cmds", loading_prepend .. process_comment .. loading_append)
    reloadDisplay(triggerId)

    --[[ì„±ê³µêµ´ë¦¼]]
    --ë³´ë„ˆìŠ¤ ìš”ì†Œ: ìœ ì € ë ˆë²¨ë‹¹ 1, ëŒ€ìƒì˜ ë°˜ë°œ ì™¸ ê°ì¸ë‹¹ 2, ê¸ì •ì  Statë ˆë²¨ë‹¹ 1
    --í˜ë„í‹° ìš”ì†Œ: ëŒ€ìƒì˜ 2^ë°˜ë°œê°ì¸, ì €í•­ statë‹¹ 1
    local rollBonus = 0
    rollBonus = rollBonus + json.decode(user)["ë ˆë²¨"] - 1 --ìœ ì € ë ˆë²¨ë‹¹ 1, 1ë ˆë²¨ë¶€í„° ì‹œì‘ì´ë¯€ë¡œ 1ì„ ì°¨ê°
    rollBonus = rollBonus - currentStat["ì €í•­"] --ì €í•­ stat 1ë ˆë²¨ë‹¹ 1ë§Œí¼ í˜ë„í‹°
    for _, v in ipairs(markDB) do -- ê°ì¸ ë³´ë„ˆìŠ¤ ì ìš©
        if v == "ë°˜ë°œê°ì¸" then
            rollBonus = rollBonus - 2^tonumber((target[v] or 0))
        else
            rollBonus = rollBonus + (target[v] or 0)*2
        end
    end

    --ìµœì¢… ì£¼ì‚¬ìœ„êµ´ë¦¼
    local roll = math.random()*MAXROLL
    local rollMsg = "ì¡°êµ ì„±ê³µ"
    if roll > MAXROLL - 1 then
        rollMsg = "ì¡°êµ ëŒ€ì„±ê³µ!"
        screenEffect = [[<div class="success-animation"><div class="animation-text success">]]..rollMsg..[[</div></div>]]
        debug(roll..">="..dc, rollMsg)
    elseif roll + rollBonus <= dc then
        rollMsg = "ì¡°êµ ì‹¤íŒ¨"
        screenEffect = [[<div class="success-animation"><div class="animation-text fail">]]..rollMsg..[[</div></div>]]
        debug(roll..">="..dc, rollMsg)
    else
        debug(roll..">="..dc, "ì„±ê³µ")
    end

    --ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ê²½í—˜ ì¶”ê°€
    if roll + rollBonus > dc and #exps > 0 then
        for _, k in ipairs(exps) do
            target[k] = target[k] + 1
        end
    end

    --[[HP,SP ì†Œëª¨ ê³„ì‚°]]
    local costHP, costSP = HP, SP
    if string.find(rollMsg, "ì‹¤íŒ¨") then --ì¡°êµê°€ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš° ì²´ë ¥ ê¸°ë ¥ì†Œëª¨ ì¦ê°€
        costHP = costHP + dc - math.abs(roll + rollBonus)
        costSP = costSP + dc - math.abs(roll + rollBonus)
    elseif string.find(rollMsg, "ëŒ€ì„±ê³µ") then --ì¡°êµê°€ ëŒ€ì„±ê³µ í•˜ë©´ ì²´ë ¥ ê¸°ë ¥ ì†Œëª¨ ê°ì†Œ
        costHP = costHP *0.8
        costSP = costSP *0.8
    end
    --ë¹„ìš© ì •ìˆ˜í™”
    costHP = math.floor(costHP)
    costSP = math.floor(costSP)
    --ì‹¤ì œ HP,SP ì°¨ê°ì²˜ë¦¬
    local currentHP, currentSP = tonumber(target["ì²´ë ¥"]), tonumber(target["ê¸°ë ¥"])
    if currentSP < costSP then --ê¸°ë ¥ì´ ë¶€ì¡±í•œ ê²½ìš° ë¶€ì¡±í•œ ê¸°ë ¥ ì†Œëª¨ì˜ ë‘ë°°ë§Œí¼ ì²´ë ¥ì†Œëª¨
        costHP = costHP + ((costSP-currentSP) *2)
    end
    debug("hp: "..currentHP, "cost: "..costHP)
    debug("sp: "..currentSP, "cost: "..costSP)
    currentHP = math.max(currentHP - costHP, 0)
    currentSP = math.max(currentSP - costSP, 0)

    --HPê°€ ë‚®ì„ ê²½ìš° ì„¤ì •ì— ë”°ë¼ ì‹¤ì‹  í˜¹ì€ ì‚¬ë§ ì²˜ë¦¬
    if currentHP < 1 then
        local ampm = getChatVar(triggerId,"ampm")
        if ampm == 0 then ampm ="ë‚®" else ampm="ë°¤" end

        local blockDeath = tonumber(getChatVar(triggerId, "blockDeath"))
        if blockDeath == 1 then --ì‹¤ì‹ ì²˜ë¦¬
            target["ì¡°êµì‹¤ì‹ ê²½í—˜"] = target["ì¡°êµì‹¤ì‹ ê²½í—˜"] + 1
            target["condition"] = "ì‹¤ì‹ "
            setState(triggerId, "target", target)
            setChatVar(triggerId, "target", target)
            local newLog = getChatVar(triggerId, "newLog")
            newLog = newLog .. "<p>ëŒ€ìƒì€ ê°€í˜¹í•œ ì¡°êµë¥¼ ê²¬ë””ì§€ ëª»í•˜ê³  ì‹¤ì‹ í–ˆë‹¤.</p>"
            setChatVar(triggerId, "newLog", newLog)
            executeFunction(triggerId, "train", "199") --ì¡°êµì¢…ë£Œ í™”ë©´ìœ¼ë¡œ ë„˜ì–´ê°€ traceë¥¼ ì–»ê³  ì–´ë¹Œì²˜ë¦¬ëŠ” í•  ìˆ˜ ìˆë„ë¡ í•¨
            alertNormal(triggerId, "ëŒ€ìƒì€ ê°€í˜¹í•œ ì¡°êµë¥¼ ê²¬ë””ì§€ ëª»í•˜ê³  ì‹¤ì‹ í–ˆìŠµë‹ˆë‹¤. ì¡°êµë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")

        else --ì‚¬ë§ì²˜ë¦¬.
            --ë³€ìˆ˜ ì´ˆê¸°í™”
            setState(triggerId, "target", "")
            setChatVar(triggerId, "target", "")
            setState(triggerId, "stat", "")
            setChatVar(triggerId, "stat", "")
            setChatVar(triggerId, "targetTrace", "")
            
            --ìºë¦­í„° ì •ë³´ ë³€ê²½
            target["condition"] = "ì‚¬ë§"
            target["ì²´ë ¥"] = 0
            target["ê¸°ë ¥"] = 0
            local option = {alwaysActive = false, insertOrder = 100, key = "", secondKey = "", regex = false}
            upsertLocalLoreBook(triggerId, target["ì´ë¦„"], json.encode(target), option)

            --ì‚¬ë§ ë¡œê·¸ ì ìš©
            local totalLog
            if getChatVar(triggerId, "oldLog") == "[ì¡°êµì‹œì‘]" then
                totalLog = getChatVar(triggerId, "newLog")
            else
                totalLog = getChatVar(triggerId, "oldLog") .. getChatVar(triggerId, "newLog")
            end
            local lastTrainLog = "<div class='showLog'><p>"..getChatVar(triggerId,"day").."ì¼ì°¨ "..ampm.." / ì¡°êµ ëŒ€ìƒ:"..target["ì´ë¦„"].."</p><p>"..totalLog.."</p><p>ëŒ€ìƒì€ ê°€í˜¹í•œ ì¡°êµë¥¼ ê²¬ë””ì§€ ëª»í•˜ê³  ì‚¬ë§í–ˆë‹¤.</p></div>"
            addChat(triggerId, "user", "{{".."getvar::html".."}}")
            setChat(triggerId, getChatLength(triggerId)-2, lastTrainLog)
            setChatVar(triggerId, "category", "items")
           screenChange(triggerId, "main")
            processAndStoreLore(triggerId, "main.lua")
            alertNormal(triggerId, "ëŒ€ìƒì´ ê°€í˜¹í•œ ì¡°êµë¥¼ ê²¬ë””ì§€ ëª»í•˜ê³  ì‚¬ë§í–ˆìŠµë‹ˆë‹¤. ì¡°êµë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        end

        return false
    end

    --ê³„ì‚°ëœ ì²´ë ¥ ê¸°ë ¥ì„ í¬ë§¤íŒ…ëœ ë¬¸ìì—´ë¡œ ì €ì¥
    target["ì²´ë ¥"] = intForm(currentHP)
    target["ê¸°ë ¥"] = intForm(currentSP)

    --[[í”„ë¡¬í”„íŠ¸ ë¹Œë”©]]
    local prompt = {}

    --ìŠ¤íƒ¯ì„ n/10ìœ¼ë¡œ ì‘ì„±í•´ LLMì´ í˜„ì¬ ìˆ˜ì¤€ì´ ì–´ëŠì •ë„ì¸ì§€ íŒë‹¨í•˜ë„ë¡ í•¨
    local statProm = {}
    for k,v in pairs(currentStat) do
        statProm[k] = v.."/10"
    end

    --targetê°€ ë³´ìœ í•œ traitì— ëŒ€í•œ ì„¤ëª…ë§Œ ì¶”ì¶œ
    local traitProm = {}
    for k,_ in pairs(traitDB) do
        local found, foundVal = hasVal(target, k)
        if found then
            traitProm[k] = foundVal --targetí•œí…Œ ìˆëŠ” trait ì„¤ëª…ë§Œ ì…ë ¥
        end
    end
    traitProm = json.encode(traitProm)

    --trainResponse (stat ê³„ì‚°) í”„ë¡¬í”„íŠ¸
    prompt = {
    promptBuild("system", getLoreBookContent(triggerId, "trainResponse.pt")),
    promptBuild("system", "- STAT: "..json.encode(statDB)),
    promptBuild("system", "- MARK: "..json.encode(markDB)),
    promptBuild("system", "- ABILITY: "..json.encode(ablDB)),
    promptBuild("system", "- TRAIT: "..json.encode(traitProm)),
    promptBuild("system", "- ITEMS: "..json.encode(itemDB)),
    promptBuild("system", "- EXP_TABLE: "..json.encode(EXPtbl)),
    promptBuild("system", "- character_sheet: "..target_c),
    promptBuild("system", "- character_stats_Lv: "..json.encode(statProm)),
    promptBuild("system", "- training_command: "..command),
    promptBuild("system", "- command_result: "..rollMsg)
    }
    local trainResponse = LLM(triggerId, prompt, "trainResponse")
    if not trainResponse.success then --LLMì‘ë‹µ ì‹¤íŒ¨ì‹œ í•¨ìˆ˜ ì¢…ë£Œ
        alertNormal(triggerId, "trainResponse LLMì‘ë‹µ ì‹¤íŒ¨"..trainResponse.result)
        setChatVar(triggerId, "cmds", old_cmds)
        reloadDisplay(triggerId)
        return false
    end

    --trainResponse ì‘ë‹µì €ì¥
    local content = trainResponse.result
    debug("statê³„ì‚°: "..content)
    --statEXP ì €ì¥
    local statEXP = content:match("({.*})")
    statEXP = json.decode(statEXP)

    --dcì— ë”°ë¥¸ statEXP íšë“ ì œì–´
    for k,v in pairs(statEXP) do
        local maxLv = math.floor(dc*0.15) --ë‚œì´ë„ 60ì´ë©´ 9ë ™, 67ì´ë©´ 10ë ™ ê²½í—˜ì¹˜ê¹Œì§€ ë°›ì„ ìˆ˜ ìˆìŒ
        local limit = EXPtbl[tostring(maxLv)]
        statEXP[k] = math.min(v, limit)
    end

    --traitì— ë”°ë¥¸ statEXP íšë“ ì œì–´
    statEXP["Uì¾Œë½"] = (statEXP["Uì¾Œë½"] or 0) * (target["ìš”ë„ì„±ê°"] or 0)
    statEXP["Mì¾Œë½"] = (statEXP["Mì¾Œë½"] or 0) * (target["ì¸í›„ì„±ê°"] or 0)

    --ê°ì¸íšë“ íŒì •. ê°ì¸ íšë“ì‹œ screenEffectë¥¼ ë®ì–´ ì”€
    local screenEffect_temp
    target, screenEffect_temp = sysFunction(triggerId, "getMark.sys", statEXP, target)
    if screenEffect_temp ~= "" then
        screenEffect = screenEffect_temp
    end

    --[[ì ˆì • ê³„ì‚°]]
    local orgasmMax_default = 10000
    local orgasm_multiplier = 1.2

    local ej_target_count = tonumber(getChatVar(triggerId, "ej_target_count"))
    local ej_target_max = orgasmMax_default*(orgasm_multiplier^ej_target_count)
    local ej_target_ratio = getChatVar(triggerId, "ej_target_ratio")
    ej_target_ratio = math.floor(tonumber(ej_target_ratio)*0.95) --ë§¤í„´ ì ˆì •ì¹˜ ìì—°ê°ì†Œì‹œí‚¤ë©´ì„œ ìˆ«ìë¡œ í˜•ë³€í™˜
    local ej_target = math.floor(ej_target_ratio * ej_target_max*0.01)

    local ej_user_count = tonumber(getChatVar(triggerId, "ej_user_count"))
    local ej_user_max = orgasmMax_default*(orgasm_multiplier^ej_user_count)
    local ej_user_ratio = getChatVar(triggerId, "ej_user_ratio")
    ej_user_ratio = math.floor(tonumber(ej_user_ratio)*0.95) --ë§¤í„´ ì ˆì •ì¹˜ ìì—°ê°ì†Œì‹œí‚¤ë©´ì„œ ìˆ«ìë¡œ í˜•ë³€í™˜
    local ej_user = math.floor(ej_user_ratio * ej_user_max*0.01)

    local ejPlus = {"Cì¾Œë½", "Vì¾Œë½", "Aì¾Œë½", "Bì¾Œë½", "Uì¾Œë½", "Mì¾Œë½", "Sì¾Œë½"} --ì ˆì •ì¹˜ë¥¼ ì¦ê°€ì‹œí‚¤ëŠ” stat
    for k, v in ipairs(ejPlus) do
        local val = statEXP[v] or 0
        ej_target = ej_target + val
        debug("ì ˆì •ì¹˜: "..v.."(+"..val..")")
    end

    local ejMinus = {"ê³µí¬", "ë¶ˆì¾Œ", "ë¶€ì •"} --ì ˆì •ì¹˜ë¥¼ ê°ì†Œì‹œí‚¤ëŠ” stat
    for k, v in ipairs(ejMinus) do
        local val = statEXP[v] or 0
        ej_target = ej_target - val
        debug("ì ˆì •ì¹˜: "..v.."(-"..val..")")
    end

    --ìƒí™©ì— ë”°ë¼ ë‹¬ë¼ì§€ëŠ” stat: "êµ´ë³µ", "ìˆ˜ì¹˜", "ê³ í†µ"
    local ejCon
    ejCon = statEXP["êµ´ë³µ"] or 0
    if hasVal(target, "ë³µì¢…ê°ì¸") == true or tonumber(target["ë´‰ì‚¬ê¸°ìˆ "])> 4 then
        ej_target = ej_target + ejCon
        debug("ì ˆì •ì¹˜: êµ´ë³µ(+"..ejCon..")")
    else
        ej_target = ej_target - ejCon
        debug("ì ˆì •ì¹˜: êµ´ë³µ(-"..ejCon..")")
    end
    ejCon = statEXP["ìˆ˜ì¹˜"] or 0
    if tonumber(target["ë…¸ì¶œë²½"])> 4 then
        ej_target = ej_target + ejCon
        debug("ì ˆì •ì¹˜: ìˆ˜ì¹˜(+"..ejCon..")")
    else
        ej_target = ej_target - ejCon
        debug("ì ˆì •ì¹˜: ìˆ˜ì¹˜(-"..ejCon..")")
    end
    ejCon = statEXP["ê³ í†µ"] or 0
    if tonumber(target["ë§ˆì¡°ë¼"])> 4 then
        ej_target = ej_target + ejCon
        debug("ì ˆì •ì¹˜: ê³ í†µ(+"..ejCon..")")
    else
        ej_target = ej_target - ejCon
        debug("ì ˆì •ì¹˜: ê³ í†µ(-"..ejCon..")")
    end

    --target ì ˆì •ì¹˜ ê³„ì‚°
    ej_target = math.min(ej_target_max, math.max(0, math.floor(ej_target)))--ì ˆì •ì¹˜ê°€ ìµœëŒ€ ìµœì†Œê°’ì„ ë„˜ì§€ ì•Šë„ë¡ í›„ì²˜ë¦¬
    ej_target_ratio = ej_target/ej_target_max*100 --ì‹¤ì œ ìˆ˜ì¹˜ë¥¼ ë³´ì—¬ì¤„ê²Œ ì•„ë‹ˆë¼ì„œ ì†Œìˆ«ì ë„ í—ˆìš©
    debug(target["ì´ë¦„"].."ì ˆì •ì¹˜: " .. ej_target, ej_target_ratio, ej_target_max)

    --user ì ˆì •ì¹˜ ê³„ì‚°
    ej_user = math.min(ej_user_max, ej_user + feeling * orgasmMax_default*0.01)
    ej_user_ratio = math.floor(ej_user/ej_user_max*100)
    debug("{{user}}ì ˆì •ì¹˜: " .. ej_user, ej_user_ratio, ej_user_max)

    --ì ˆì •ì—¬ë¶€ ì²´í¬
    local ejMsg = "ì•„ë¬´ë„ ì ˆì •í•˜ì§€ ì•ŠìŒ."
    local orgasm_t, orgasm_u = false, false
    if ej_target >= ej_target_max then
        ejMsg = "ì¡°êµëŒ€ìƒ ì ˆì •."
        orgasm_t = true
        ej_target_count = ej_target_count +1
        ej_target_ratio = 0
    end
    if ej_user >= ej_user_max then
        ejMsg = "{{user}} ì ˆì •."
        orgasm_u = true
        ej_user_count = ej_user_count +1
        ej_user_ratio = 0
    end



    --ì ˆì •ê²½í—˜ ì¶”ê°€
    if orgasm_t then
        target["ì ˆì •ê²½í—˜"] = target["ì ˆì •ê²½í—˜"] + 1
    end
    --[[ ìœ ì €ì˜ ì ˆì •....ê²½í—˜ì²˜ë¦¬ê°€ í•„ìš”í•œê°€?
    if orgasm_u then
        user["ì ˆì •ê²½í—˜"] = user["ì ˆì •ê²½í—˜"] + 1
    end]]

    --ìŠ¤íƒ¯ë³€í™”ê°’ì„ ê°€ì ¸ì™€ currentstatì´ ë ˆë²¨ì—… í•˜ëŠ”ì§€ë¥¼ stat.dbì˜ í…Œì´ë¸”ì˜ ê° ë ˆë²¨ê°’ê³¼ ë¹„êµí•´ í™•ë¥ ì ìœ¼ë¡œ ê³„ì‚°
    local lvUpcomment = ""
    local statResult = {}
    local lvUp
    lvUp = function(remainStat , currentLv, statName)
        local lv = tostring(currentLv)
        local remainStat = remainStat
        local r = math.random()
        debug(statName..": "..remainStat.."/"..EXPtbl[lv]..": "..remainStat/EXPtbl[lv] .. " > " .. r)
        if remainStat/EXPtbl[lv] > r then
            remainStat = math.max(remainStat - EXPtbl[lv], 0)
            lv = lvUp(remainStat, lv+1, statName)
            return lv
        else
            return lv
        end
    end

    for k, _ in pairs(currentStat) do
        local v = statEXP[k] or "0" -- statEXPì— í•´ë‹¹ í‚¤ê°’ì´ ì—†ì„ ê²½ìš° 0ì„ ë°˜í™˜í•˜ë„ë¡ í•´ ì—ëŸ¬ë°©ì§€
        local lv = currentStat[k]
        if tonumber(v) > 0 then
            statResult[k] = tonumber(lvUp(v, lv, k))
            currentStat[k] = tonumber(currentStat[k])
            if currentStat[k] < statResult[k] then
                lvUpcomment = lvUpcomment.. "<br>â€» " .. k .. "ì´(ê°€) " .. currentStat[k] .. "ì—ì„œ " .. statResult[k] .. "ë¡œ ì¦ê°€í–ˆìŠµë‹ˆë‹¤!"
            end
        else
            statResult[k] = lv
        end
    end

    local process_comment = "[ì¡°êµ ë¡œê·¸ ìƒì„±ì¤‘]"
    setChatVar(triggerId, "cmds", loading_prepend .. process_comment .. loading_append)
    reloadDisplay(triggerId)
    
    --[[trainLog í”„ë¡¬í”„íŠ¸ ë¹Œë”©]]
    --ê¸°ì¡´ ë¡œê·¸ ë¶ˆëŸ¬ì˜´
    local oldLog
    if getChatVar(triggerId, "oldLog") == date then
        oldLog = getChatVar(triggerId, "newLog")
    else
        oldLog = getChatVar(triggerId, "oldLog") .. getChatVar(triggerId, "newLog")
    end

    prompt = {
    promptBuild("system", getLoreBookContent(triggerId, "system.pt")),
    promptBuild("system", getLoreBookContent(triggerId, "trainLog.pt")),
    promptBuild("system", getLoreBookContent(triggerId, "worldBriefing.pt")),
    promptBuild("system", "- STAT: "..json.encode(statDB)),
    promptBuild("system", "- MARK: "..json.encode(markDB)),
    promptBuild("system", "- ABILITY: "..json.encode(ablDB)),
    promptBuild("system", "- TRAIT: "..json.encode(traitProm)),
    promptBuild("system", "- ITEMS: "..json.encode(itemDB)),
    promptBuild("system", "- character_sheet: "..target_c),
    promptBuild("system", "- character_stats_Lv: "..json.encode(statResult)),
    promptBuild("system", "- character_stats_Lv: "..equipments),
    promptBuild("system", "- {{user}}'s_profile: "..user),
    promptBuild("system", "- King's_profile: "..king),
    promptBuild("system", "- training_command: "..command), --ì¡°êµëª…ë ¹
    promptBuild("system", "- command_result: "..rollMsg), --ì„±ê³µì—¬ë¶€
    promptBuild("system", "- orgasm: "..ejMsg), --ì ˆì •ì—¬ë¶€
    promptBuild("system", "## Train Log"), --ë¡œê·¸ ì‹œì‘
    promptBuild("assistant", oldLog) --ê¸°ì¡´ ë¡œê·¸
    }

    local trainLog = LLM(triggerId, prompt, "trainLog") --LLMì— ì‘ë‹µ ìš”ì²­
    if not trainLog.success then --LLMì‘ë‹µ ì‹¤íŒ¨ì‹œ í•¨ìˆ˜ ì¢…ë£Œ
        alertNormal(triggerId, "trainLog LLMì‘ë‹µ ì‹¤íŒ¨".. trainLog.result)
        setChatVar(triggerId, "cmds", old_cmds)
        reloadDisplay(triggerId)
        return false
    end

    --[[ì‘ë‹µì²˜ë¦¬]]
    --ì‹ ê·œë¡œê·¸ ì €ì¥
    local dialog = trainLog.result
    --ìƒê°ì˜ ì‚¬ìŠ¬ ì œê±°
    dialog = dialog:gsub("<Thoughts>.-</Thoughts>", "")
    debug("ì¡°êµë¡œê·¸: "..dialog)
    local newLog = "<br>" .. dialog

    --ìˆ˜ì •êµ¬ ë…¹í™”ë¡œê·¸ ì €ì¥
    if TRAIN_REC > 0 then
        debug("ìˆ˜ì •êµ¬ì˜ìƒ ë…¹í™”ì¤‘. ì”ì—¬íšŒìˆ˜: "..TRAIN_REC)
        if TRAIN_REC == 1 then
            newLog = newLog .. "<br>â€» ìˆ˜ì •êµ¬ ì˜ìƒì˜ ë…¹í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
        end
        executeFunction(triggerId, "train", "200", date, target["ì´ë¦„"], newLog)
    end

    --[[ë§ˆë¬´ë¦¬ ì²˜ë¦¬]]
    setChatVar(triggerId, "cmds", old_cmds) --ë²„íŠ¼ ì›ë³µ
    setChatVar(triggerId, "statLvUp", lvUpcomment) --stat ë³€í™” ì„¤ëª…ì€ logì— í¬í•¨ë˜ì§€ ì•Šë„ë¡ ë³„ë„ ì²˜ë¦¬
    setState(triggerId, "stat", statResult) --ë³€ê²½ëœ statì„ stateì— ë°˜ì˜
    local stat_c = "{"
    for k, v in pairs(statResult) do
        stat_c = stat_c .. '"'..k..'":"'..v..'",'
    end
    stat_c = string.gsub(stat_c, ",$", "}")-- ë§ˆì§€ë§‰ ì‰¼í‘œ ëŒ€ì‹  ì¤‘ê´„í˜¸ ë‹«ê¸°
    setChatVar(triggerId, "stat", stat_c) --ë³€ê²½ëœ statì„ chatVarì— ë°˜ì˜

    --ì ˆì •ì¹˜ ë³€ìˆ˜ì— ì ìš©
    setChatVar(triggerId, "ej_target_count", ej_target_count)
    setChatVar(triggerId, "ej_target_ratio", string.format("%.2f", ej_target_ratio))
    setChatVar(triggerId, "ej_user_count", ej_user_count)
    setChatVar(triggerId, "ej_user_ratio", string.format("%.2f", ej_user_ratio))

    --ë¡œê·¸ ì²˜ë¦¬
    setChatVar(triggerId, "oldLog", oldLog)
    setChatVar(triggerId, "newLog", newLog)

    --ì‹¤íŒ¨/ëŒ€ì„±ê³µ ì „ì—­í™”ë©´ íš¨ê³¼ ì €ì¥. getMarkì—ì„œ ì±—ë³€ìˆ˜ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ë‹¤ë©´ í˜„ì¬ ì¡°êµ ì„±ê³µì‹¤íŒ¨ htmlì„ ì…ë ¥
    if getChatVar(triggerId, "screenEffect") == "" then
        setChatVar(triggerId, "screenEffect", screenEffect)
    end

    --ì¡°êµê°„ì— ë³€ê²½ëœ ìœ ì € ë˜ëŠ” ëŒ€ìƒì˜ ì •ë³´(hp, sp ì ˆì •ê²½í—˜ ë“±)ì€ stateì™€ ì±—ë³€ìˆ˜ì— ìŒ“ì•„ë’€ë‹¤ê°€ ì¡°êµ ì¢…ë£Œì‹œì— ë¡œì–´ë¶ìœ¼ë¡œ ë°˜ì˜.
    setState(triggerId, "target", target)
    stateToVar(triggerId, "target", target)

    reloadDisplay(triggerId)
end