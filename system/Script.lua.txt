--ê¸°ë³¸ ë³€ìˆ˜
local TIME = -1
local SPAMING = 0.2
local DEBUG = 1      --ë””ë²„ê·¸ í™œì„±í™” ì—¬ë¶€
local MAXROLL = 30   --ì¡°êµì„±ê³µêµ´ë¦¼
local TRAIN_REC = 0  --ìˆ˜ì •êµ¬ ë…¹í™” ë‚¨ì€íšŒìˆ˜
local DC_PENALTY = 1 --ì¡°êµ ë‚œì´ë„êµ´ë¦¼ ì „ì—­ í˜ë„í‹°. 1ë³´ë‹¤ ì‘ìœ¼ë©´ ë³´ë„ˆìŠ¤

--ì „ì—­ ìƒìˆ˜
local DEFAULT_LORE_OPTION = { alwaysActive = false, insertOrder = 100, key = "", secondKey = "", regex = false }
local DB_CACHE = {}   --ë¡œì–´ë¶ DB ìºì‹œ ì €ì¥ì†Œ
local LORE_CACHE = {} --ë¡œì–´ë¶ ì»¨í…ì¸  ìºì‹œ ì €ì¥ì†Œ

--====================================
-- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
--====================================

--ë¡œì–´ë¶ DB ìºì‹± ë©”ì»¤ë‹ˆì¦˜
--DBë¥¼ í•œ ë²ˆë§Œ ë¡œë“œí•˜ê³  ì´í›„ì—ëŠ” ìºì‹œì—ì„œ ë°˜í™˜
function getDB(triggerId, dbName)
    local key = dbName
    if not DB_CACHE[key] then
        local content = getLoreBookContent(triggerId, dbName)
        DB_CACHE[key] = json.decode(content)
        debug("DB ìºì‹œ ì €ì¥: " .. dbName)
    end
    return DB_CACHE[key]
end

--DB ìºì‹œ ì´ˆê¸°í™” (ê²Œì„ ì‹œì‘ì‹œ ë˜ëŠ” í•„ìš”ì‹œ í˜¸ì¶œ)
function clearDBCache()
    DB_CACHE = {}
    LORE_CACHE = {}
    debug("DB ë° Lore ìºì‹œ ì´ˆê¸°í™”ë¨")
end

--ë‚ ì§œ/ì‹œê°„ ë¬¸ìì—´ ìƒì„± ìœ í‹¸ë¦¬í‹°
--format: "full" = "day1 â˜€ï¸ ë‚®", "short" = "1ì¼ì§¸, ë‚®", "log" = "1ì¼ì°¨ ë‚®"
function getDateString(triggerId, form)
    local day = getChatVar(triggerId, "day")
    local ampm = tonumber(getChatVar(triggerId, "ampm"))
    local ampmText = ampm == 0 and "ë‚®" or "ë°¤"
    local ampmIcon = ampm == 0 and "â˜€ï¸" or "ğŸŒ™"

    form = form or "full"
    if form == "full" then
        return "day" .. day .. " " .. ampmIcon .. " " .. ampmText
    elseif form == "short" then
        return day .. "ì¼ì§¸, " .. ampmText
    elseif form == "log" then
        return day .. "ì¼ì°¨ " .. ampmText
    else
        return day .. "ì¼ " .. ampmText
    end
end

--ë””ë²„ê¹…ìš©
function debug(...)
    if DEBUG == 1 then
        print(...)
    end
end

--tonumberë¥¼ ì½¤ë§ˆì œê±°í›„ ìˆ«ìë¡œ ì¸ì‹í•˜ë„ë¡ ì˜¤ë²„ë¼ì´ë”©
old_tonumber = tonumber
tonumber = function(str, base)
    if type(str) == "string" then
        local cleaned_str = string.gsub(str, ",", "")
        return old_tonumber(cleaned_str, base)
    else
        return str, base
    end
end

--LLMí•¨ìˆ˜ ì˜¤ë²„ë¼ì´ë“œ
old_LLM = LLM
LLM = function(triggerId, prompt, callName)
    local models = json.decode(getChatVar(triggerId, "models"))
    local modelSelect = models[callName]
    local response

    if modelSelect == "1" then
        response = old_LLM(triggerId, prompt)
    else
        response = axLLM(triggerId, prompt)
    end

    return response
end

--ì‹œê°„ê°’ ì¶œë ¥
function time()
    if os.clock() < 0 then
        return os.time()
    else
        return os.clock() --35ë¶„ ì§€ë‚˜ë©´ ì˜¤ë²„í”Œë¡œìš°ë¡œ ëª»ì”€
    end
end

--upsertLocalLoreBook ì˜¤ë²„ë¼ì´ë“œ
old_upsertLocalLoreBook = upsertLocalLoreBook
upsertLocalLoreBook = function(triggerId, name, content, ...)
    old_upsertLocalLoreBook(triggerId, name, content, ...)
    local modContent = string.gsub(content, "%s*///[^\n]*\n?", "\n")
    LORE_CACHE[name] = modContent
    debug("Lore ìºì‹œ ì—…ë°ì´íŠ¸: " .. name)
end

--ì •ìˆ˜ í¬ë§·íŒ…
function intForm(str)
    if tonumber(str) ~= nil and tonumber(str) >= 1000 then --ìˆ«ìë³€í™˜ì´ ë¶ˆê°€í•˜ë©´ ë°”ì´íŒ¨ìŠ¤í•˜ê³  ì…ë ¥ê°’ì„ ë‹¤ì‹œ ë°˜í™˜
        str = string.reverse(string.reverse(string.format("%.0f", str)):gsub("(%d%d%d)", "%1,"))
        if string.sub(str, 1, 1) == "," then
            str = string.sub(str, 2)
        end
    end
    return str
end

--í…Œì´ë¸” ê¸¸ì´ íŒŒì•…
function len(tbl)
    local len = 0
    if type(tbl) ~= "table" then
        debug(tbl .. "ì€ ì˜¬ë°”ë¥¸ í…Œì´ë¸”ì´ ì•„ë‹™ë‹ˆë‹¤.")
        return false
    end
    for k, v in pairs(tbl) do
        len = len + 1
    end
    return len
end

--tableì— valì´ ìˆëŠ”ì§€ í™•ì¸.
--ì‹ ì²´íŠ¹ì„± ê°™ì€ ë°°ì—´ ë‚´ì— ìˆëŠ” ê°’ë„ ì²´í¬í•˜ê¸° ìœ„í•´ ë°¸ë¥˜ë„ í•¨ê»˜ ì²´í¬
--returnìœ¼ë¡œ ë°¸ë¥˜ë¥¼ ë°˜í™˜í•˜ë„ë¡ í•´ í•¨ìˆ˜ í™œìš©ì„±ì„ ë†’ì„
function hasVal(tbl, val)
    for k, v in pairs(tbl) do
        if k == val or v == val then
            return true, v
        end
        if type(v) == "table" then
            local found, foundVal = hasVal(v, val)
            if found then
                return found, foundVal
            end
        end
    end
    return false, nil
end

--ë¡œì–´ë¶ ì»¨í…ì¸  ë¡œë”©
function getLoreBookContent(triggerId, lore)
    -- HTML íŒŒì¼ì€ ìºì‹œí•˜ì§€ ì•ŠìŒ (UI ê°±ì‹  ë¬¸ì œ ë°©ì§€)
    if string.find(lore, "%.html$") then
        local rawContent = getLoreBooks(triggerId, lore)[1].content
        local modContent = string.gsub(rawContent, "%s*///[^\n]*\n?", "\n")
        return modContent
    end

    if LORE_CACHE[lore] then
        --debug("Lore ìºì‹œ ì ì¤‘: " .. lore)
        return LORE_CACHE[lore]
    end

    local rawContent = getLoreBooks(triggerId, lore)[1].content
    local modContent = string.gsub(rawContent, "%s*///[^\n]*\n?", "\n") --ë¡œì–´ë¶ ì£¼ì„ì²˜ë¦¬ "///" ì œê±°

    LORE_CACHE[lore] = modContent
    debug("Lore ìºì‹œ ìƒì„±: " .. lore)
    return modContent
end

--í…Œì´ë¸”ì„ 1ì°¨ì›ìœ¼ë¡œ flatten
function flatten(tbl)
    local result = {}
    -- ì…ë ¥ëœ í…Œì´ë¸”ì˜ ëª¨ë“  ìš”ì†Œë¥¼ ìˆœíšŒ
    local function doFlatten(tbl)
        for k, v in pairs(tbl) do
            if type(v) == "table" then --ê°’ì´ í…Œì´ë¸”ì´ë©´ ì¬ê·€
                if k == "ì´ìƒê²½í—˜ ê¸°ë¡" then
                    result[k] = v      --ì´ìƒê²½í—˜ ê¸°ë¡ì€ í‰íƒ„í™” ê¸ˆì§€. ê°œì„ ë°©ì•ˆ ê³ ë¯¼ í•„ìš”í•¨
                end
                doFlatten(v)
            elseif type(k) == "number" then --í‚¤ê°€ ì¸ë±ìŠ¤(ë°°ì—´)ì´ë©´ í‚¤ê°’ì— ê°’ì„ ë„£ê³  ë°¸ë¥˜ëŠ” "1"
                result[v] = "1"
            else
                result[k] = v --ì¼ë°˜ì ì¸ í‚¤:ê°’ ìƒíƒœë©´ ê·¸ëŒ€ë¡œ ì…ë ¥
            end
        end
    end
    doFlatten(tbl)
    return result
end

-- stateì— ì €ì¥ëœ í…Œì´ë¸”ì„ ì±—ë³€ìˆ˜varNameìœ¼ë¡œ í• ë‹¹. ì…ë ¥ëœ í…Œì´ë¸”ì„ 1ì°¨ì›ìœ¼ë¡œ flattení•¨
function stateToVar(triggerId, key, tbl)
    --í…Œì´ë¸”ì„ ë¦¬ìˆ˜ ë”•ì…”ë„ˆë¦¬/ë°°ì—´ ì–‘ì‹ì— ë§ê²Œ ë³€í˜•
    local tbl = flatten(tbl)
    local new_tbl = ""
    local function checkArray(v) --ë°°ì—´ì¸ì§€ í™•ì¸
        for k, _ in pairs(v) do
            if type(k) ~= "number" then
                return false
            end
        end
        return true
    end

    if checkArray(tbl) then --tblì´ ë°°ì—´ì´ë©´
        --ë°°ì—´ì²˜ë¦¬
        new_tbl = "["
        for _, v in pairs(tbl) do
            new_tbl = new_tbl .. '"' .. v .. '",'
        end
        new_tbl = string.gsub(new_tbl, ",$", "]")
    else
        --ë”•ì…”ë„ˆë¦¬ì²˜ë¦¬
        new_tbl = "{"
        for k, v in pairs(tbl) do
            if type(v) == "table" then --ì´ìƒê²½í—˜ê¸°ë¡ì€ í‰íƒ„í™” ì•ˆí•´ì„œ ê°’ì´ í…Œì´ë¸”ì´ë¯€ë¡œ encodeí•´ì„œ ì§‘ì–´ë„£ìŒ ì¶”í›„ ê°œì„ ì•ˆ í•„ìš”í•¨.
                v = json.encode(v)
            end
            new_tbl = new_tbl .. '"' .. k .. '":"' .. v .. '",'
        end
        new_tbl = string.gsub(new_tbl, ",$", "}")
    end
    debug("state to chatVar: " .. key, new_tbl)
    setChatVar(triggerId, key, new_tbl)
end

--ì´ˆê¸°ì„¸íŒ… í•¨ìˆ˜
function initialize(triggerId)
    debug("ì´ˆê¸° ì„¸íŒ… ê°œì‹œ...")
    sysFunction(triggerId, "initVars.sys")
    setChatVar(triggerId, "category", "user")
    screenChange(triggerId, "config")
    processAndStoreLore(triggerId, "config.lua")
end

--screen ì „í™˜
function screenChange(triggerId, newScreen)
    setState(triggerId, "oldScreen", getState(triggerId, "screen"))
    setState(triggerId, "screen", newScreen)
    debug("í™”ë©´ ì „í™˜: " .. newScreen)
end

-- ë¬¸ìì—´ í•¨ìˆ˜ë¥¼ ì‹¤ì œ í•¨ìˆ˜ ê°ì²´ë¡œ ë³€í™˜
function createFunctionFromString(functionString)
    local returnableString = "return " .. functionString

    local chunk, errorMessage = load(returnableString, "lore_function", "t", _G)
    if not chunk then
        return nil, "ì»´íŒŒì¼ ì˜¤ë¥˜: " .. (errorMessage or "ì•Œ ìˆ˜ ì—†ìŒ")
    end

    local success, result = pcall(chunk)
    if success and type(result) == "function" then
        return result, nil
    else
        return nil, "ì‹¤í–‰ ì˜¤ë¥˜: " .. tostring(result)
    end
end

--- ë¡œì–´ í…ìŠ¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ì—¬ funcs í…Œì´ë¸”ì— ì €ì¥
function processAndStoreLore(triggerId, loreBookId)
    local funcs = getState(triggerId, "funcs")
    
    -- debugCmdsëŠ” í•œ ë²ˆë§Œ ë¡œë“œí•˜ë„ë¡ ìºì‹± ì²´í¬
    if not funcs or not funcs["0000"] then
        sysFunction(triggerId, "debugCmds.sys") --ë””ë²„ê·¸ í•¨ìˆ˜ ì €ì¥ (ìµœì´ˆ 1íšŒë§Œ)
        funcs = getState(triggerId, "funcs") -- debugCmds ì‹¤í–‰ í›„ funcs ê°±ì‹ 
    end
    
    --debug(loreBookId .. "ë¡œì–´ë¶ì—ì„œ í•¨ìˆ˜ í˜¸ì¶œ")
    local loreEntries = getLoreBookContent(triggerId, loreBookId)

    local pattern = "%[(%S+)/(%S+)/([^%]]+)%]%s*(function.-end)!!"
    local count = 0
    local cmds = ""


    for page, number, description, functionBody in loreEntries:gmatch(pattern) do
        local key = page .. "_" .. number
        funcs[key] = functionBody
        --debug(description.."-> funcs['" .. key .. "']ì— í•¨ìˆ˜ ì €ì¥ë¨.")
        count = count + 1

        --cmds ì±—ë³€ìˆ˜ì— ë²„íŠ¼ë“¤ ì…ë ¥
        if number == "hr" then --êµ¬ë¶„ì„  ì²˜ë¦¬
            cmds = cmds ..
                "<div style='text-align:center;border-bottom:solid 1px;width:100%;margin:0.1em;grid-column:1/-1;'>" ..
                description .. "</div>"
        elseif description ~= "hidden" then
            cmds = cmds ..
                "<button class='btn command-btn' risu-btn='" .. number .. "'>[" .. number .. "] " .. description ..
                "</button>"
        end
    end
    setChatVar(triggerId, "cmds", cmds)
    setState(triggerId, "funcs", funcs)
    reloadDisplay(triggerId)
    debug("ì²˜ë¦¬ ì™„ë£Œ. ì´ " .. count .. "ê°œì˜ í•¨ìˆ˜ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤.\n")
end

function executeFunction(triggerId, screen, code, ...)
    local f_code = screen .. "_" .. code
    local funcs = getState(triggerId, "funcs")
    local funcBody = funcs[f_code]

    if not funcBody then
        funcBody = funcs[code]
        if not funcBody then
            alertNormal(triggerId, "ì»¤ë§¨ë“œ ì˜¤ë¥˜: " .. f_code .. ("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì»¤ë§¨ë“œ"))
            return
        end
    end
    local func, err = createFunctionFromString(funcBody)
    debug(f_code .. " í•¨ìˆ˜ ì‹¤í–‰(exeFunc)")
    func(triggerId, ...)
end

function sysFunction(triggerId, f_code, ...)
    local funcBody = getLoreBookContent(triggerId, f_code)
    if not funcBody then
        alertNormal(triggerId, "ì‹œìŠ¤í…œ ì»¤ë§¨ë“œ ì˜¤ë¥˜: " .. ("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì»¤ë§¨ë“œ"))
        return
    end
    local func, err = createFunctionFromString(funcBody)
    debug(f_code .. " í•¨ìˆ˜ ì‹¤í–‰(sysFunc)")
    return func(triggerId, ...)
end

function promptBuild(_role, _content)
    local prompt = {
        role = _role,
        content = _content
    }
    return prompt
end

listenEdit("editDisplay", function(triggerId, data)
    local screen = getState(triggerId, "screen")
    if not screen then
        screenChange(triggerId, "gameStart")
        screen = getState(triggerId, "screen")
    end

    --í˜„ì¬ í˜ì´ì§€ì— ë§ëŠ” htmlí˜¸ì¶œ
    local html = getLoreBookContent(triggerId, screen .. ".html")
    setChatVar(triggerId, "html", html)
    local gameStart = getLoreBookContent(triggerId, "gameStart.html")
    setChatVar(triggerId, "gamestart", gameStart)
    if gameStart ~= html then
        setChatVar(triggerId, "gamestart", "")
    end
end)

--ê¸°ë³¸ ì…ë ¥ì°½ì„ í†µí•´ ë¦¬í€˜ê°€ ê°€ëŠ”ê±¸ ë°©ì§€ + ì…ë ¥í•œ ë²ˆí˜¸ ìºì¹˜í•´ì„œ í•¨ìˆ˜ìˆ˜í–‰
onStart = async(function(triggerId)
    stopChat(triggerId)
    if time() - TIME < SPAMING then
        print(time, TIME)
        alertError(triggerId, "ë©”ì‹œì§€ê°€ ë‹¨ ì‹œê°„ì— ë„ˆë¬´ ë§ì´ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
        print("ìŠ¤íŒ¨ë° ë©ˆì¶°!")
        return false
    end
    local success, command = pcall(getUserLastMessage, triggerId)
    debug(success, command)
    if command == null then
        print("ë¦¬í€˜ ì°¨ë‹¨")
        return false
    end
    removeChat(triggerId, getChatLength(triggerId) - 1)
    local screen = getState(triggerId, "screen")
    debug("í˜„ì¬ " .. screen .. " í™”ë©´ì— ìˆìŠµë‹ˆë‹¤.")
    executeFunction(triggerId, "debug", command)
    debug("ë¦¬í€˜ ì°¨ë‹¨")

    --í˜„ì¬ í˜ì´ì§€ì— ë§ëŠ” htmlí˜¸ì¶œ
    screen = getState(triggerId, "screen")
    local html = getLoreBookContent(triggerId, screen .. ".html")
    setChatVar(triggerId, "html", html)
    debug(screen .. ".html í™”ë©´ì„ ê°±ì‹ í•©ë‹ˆë‹¤.")
    processAndStoreLore(triggerId, screen .. ".lua")
    TIME = time()

    return false
end)

onButtonClick = async(function(triggerId, data)
    setChatVar(triggerId, "screenEffect", "") --ë²„íŠ¼ ëˆ„ë¥¼ë•Œë§ˆë‹¤ screenEffect ì´ˆê¸°í™”
    if data == "gameStart" then
        initialize(triggerId)
        print("ê²Œì„ ì‹œì‘")
    else
        --ìŠ¤íŒ¸ì²˜ë¦¬
        if time() - TIME < SPAMING then
            debug(time, TIME)
            alertError(triggerId, "ë©”ì‹œì§€ê°€ ë‹¨ ì‹œê°„ì— ë„ˆë¬´ ë§ì´ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
            print("ìŠ¤íŒ¨ë° ë©ˆì¶°!")
            return false
        end

        local screen = getState(triggerId, "screen")
        if string.find(data, "charInfo") then --ìºë¦­í„°ì¹´ë“œ í´ë¦­ì‹œ ì‘ë™
            --local cmd = string.match(data, "(.*)_charInfo") --ìˆ«ìì…ë ¥ì„ í†µí•œ ìºë¦­í„° ì„ íƒì˜ êµ¬í˜„ì€ ì¶”í›„ ê³ ë¯¼
            local name = string.match(data, "charInfo_(.*)")
            
            -- disposal í™”ë©´ì—ì„œëŠ” ì²˜ë¶„ ì„ íƒìœ¼ë¡œ ì²˜ë¦¬
            if screen == "disposal" then
                -- userëŠ” ì²˜ë¦¬ ë¶ˆê°€
                if name == "user" or name == "{{user}}" then
                    alertError(triggerId, "ìœ ì €ëŠ” ì²˜ë¶„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    return false
                end
                setChatVar(triggerId, "selectedChar", name)
                sysFunction(triggerId, "disposalSelect.sys", name)
            else
                local f_code = "charCard.sys"
                sysFunction(triggerId, f_code, name)
            end

            -- ì‚¬ì „ ë²„íŠ¼ í´ë¦­ (ë™ì  ë¼ìš°íŒ…)
        elseif string.find(data, "dict_") then
            -- dict_ì¹´í…Œê³ ë¦¬_í•­ëª©ì´ë¦„ í˜•íƒœ íŒŒì‹±
            -- í•­ëª©ì´ë¦„ì— _ê°€ í¬í•¨ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì •ê·œì‹ ì£¼ì˜
            local category, name = string.match(data, "dict_([^_]+)_(.*)")
            if category and name then
                sysFunction(triggerId, "dictSelect.sys", category, name)
            else
                debug("ì˜ëª»ëœ ì‚¬ì „ í‚¤ í˜•ì‹: " .. data)
            end
        else
            executeFunction(triggerId, screen, data)
        end

        --í˜„ì¬ í˜ì´ì§€ì— ë§ëŠ” htmlí˜¸ì¶œ
        screen = getState(triggerId, "screen")
        local html = getLoreBookContent(triggerId, screen .. ".html")
        setChatVar(triggerId, "html", html)
        debug(screen .. ".html í™”ë©´ì„ ê°±ì‹ í•©ë‹ˆë‹¤.")
        processAndStoreLore(triggerId, screen .. ".lua")
        TIME = time()
    end
end)
