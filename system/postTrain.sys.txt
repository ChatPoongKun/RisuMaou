function (triggerId)
    local target = getState(triggerId, "target") --조교 종료시의 캐릭터 정보를 호출
    local exp = getDB(triggerId, "EXPtable.db") --경험치 테이블 호출
    local allTraces = getState(triggerId, "trace") --모든 대상의 trace을 호출
    local traceCurrent = allTraces[target["이름"]] or {}
    local totalTrace = 0 --spirit으로 전환할 trace 합계
    
    -- traceDB 로드 (유효한 흔적 키인지 확인용)
    local traceDB = getDB(triggerId, "trace.db")
    local validTraces = {}
    for k, v in pairs(traceDB) do
        if v.name then validTraces[v.name] = true end
    end

    --조교 종료시의 stat레벨에 따라 traceEXP를 저장 (stat은 한글 키)
    local stat = getState(triggerId, "stat")
    local traceEXP = {}

    for k, v in pairs(stat) do
        local val = tonumber(v)
        if val > 0 then
            local lvMin = tostring(val-1)
            local minExp = exp[lvMin] or 0
            local maxExp = exp[tostring(val)] or 0
            
            if maxExp > 0 then
                traceEXP[k] = math.random(minExp, maxExp) --stat 경험치를 랜덤하게 얻되 범위는 stat레벨-1에서 현재 레벨까지로 설정
            else
                traceEXP[k] = 0
            end
            
            if traceEXP[k] == 0 then
                traceEXP[k] = nil --traceEXP를 1이상 얻지못하면 테이블에서 제거
            else
                totalTrace = totalTrace + traceEXP[k] --traceEXP를 획득하면 totalTrace에 합산
            end
        end
    end
    debug("traceEXP: "..json.encode(traceEXP))
    
    --traceEXP에 따라 trace을 획득
    local statDB = getDB(triggerId, "stat.db")
    -- statDB 역매핑 (Name -> Related List)
    local statDBMap = {}
    for k, v in pairs(statDB) do
        if v.name then statDBMap[v.name] = v.related end
    end
    
    local traceAdd = {}
    local traceSum = {}
    
    -- traceSum 초기화 (traceCurrent 복사)
    for k, v in pairs(traceCurrent) do 
        traceSum[k] = v
    end
    
    local traceSort = {}
    
    for k, val in pairs(traceEXP) do -- trace획득량 계산 (k는 한글 스탯명)
        local relatedList = statDBMap[k]
        if relatedList and #relatedList > 0 then
            local len = #relatedList
            local totalWeight = len * (len + 1) * 0.5 -- 1부터 len까지 합 (가중치 총합)

            for i, traceName in ipairs(relatedList) do
                -- 유효한 흔적 이름인지 확인
                if validTraces[traceName] then
                    -- 가중치: 목록의 앞에 있을수록 높음 (len, len-1, ..., 1)
                    local weight = len - i + 1
                    local addAmount = math.floor(val * weight / totalWeight)
                    
                    traceAdd[traceName] = addAmount
                    traceSum[traceName] = (traceSum[traceName] or 0) + addAmount
                end
            end
        end
    end

    --부정이 0보다 큰 경우에만 차감로직 실행
    local deductLevel = 0 --각 흔적에서 차감하게 될 양
    local deduct = traceSum["부정"] or 0 --차감 대상 부정구슬의 양
    local deductSum = 0 --실제 차감한 부정 구슬의 합계
    
    if deduct > 0 then
        --traceSort에 부정을 제외한 0이상의 흔적 입력
        for k, v in pairs(traceSum) do
            if k ~= "부정" and v > 0 then
                table.insert(traceSort, v)
            end
        end

        --traceSort 오름차순 정렬
        table.sort(traceSort)

        --deductLevel계산
        for i, v in ipairs(traceSort) do
            local len = #traceSort - i + 1 --남은 차감 대상의 수
            local cost = v - deductLevel --현재 단계에서 차감해야할 비용
            
            if cost > 0 then
                local sub = cost * len --현재 단계에서 필요한 총비용
                if deduct >= sub then --부정구슬이 남으면
                    deduct = deduct - sub --부정구슬에서 현재단계 필요비용만큼 차감
                    deductSum = deductSum + sub
                    deductLevel = v
                else --안남으면 for문 중단
                    local delta = math.floor(deduct/len)
                    deductLevel = deductLevel + delta
                    deductSum = deductSum + delta*len
                    break
                end
            end
        end
    end

    --실제 흔적에 획득/차감 반영
    local traceText = "조교로부터 "..intForm(totalTrace).." Spirit을 획득했습니다.<br>"
    for k, v in pairs(traceSum) do
        local pp = traceAdd[k] or 0
        local mm = 0
        if k ~= "부정" then
            mm = math.min(deductLevel, v)
        end
        
        --trace 변동 텍스트
        if pp ~= 0 or mm ~= 0 or (k == "부정" and deductSum > 0) then
            if k =="부정" then
                traceText = traceText .. k ..": " .. (traceCurrent[k] or 0) .. " + " .. pp .. " - " .. deductSum .. " = " .. (traceCurrent[k] or 0)+pp-deductSum .. "<br>"
            else
                traceText = traceText .. k ..": " .. (traceCurrent[k] or 0) .. " + " .. pp .. " - " .. mm .. " = " .. (traceCurrent[k] or 0)+pp-mm .. "<br>"
            end
        end
        
        --traceCurrent에 변동값 반영
        if k =="부정" then
            traceCurrent[k] = (traceCurrent[k] or 0) + (traceAdd[k] or 0) - deductSum
        else
            traceCurrent[k] = math.max((traceCurrent[k] or 0) + (traceAdd[k] or 0) - deductLevel, 0)
        end
    end

    --조교로 얻은 spirit 합산
    local spirit = tonumber(getChatVar(triggerId, "spirit") or "0") --기존 값이 "10,000" 형태라면 tonumber 실패 가능성 -> intForm 역함수 필요하나 로직상 숫자 문자열 가정
    -- initVars에서 "10,000"으로 초기화함. 쉼표 제거 필요.
    if type(getChatVar(triggerId, "spirit")) == "string" then
        spirit = tonumber((getChatVar(triggerId, "spirit"):gsub(",", ""))) or 0
    end
    
    spirit = intForm(spirit + totalTrace)
    setChatVar(triggerId, "spirit", spirit)

    --조교로 변경된 target값을 로어북에 업데이트
    upsertLocalLoreBook(triggerId, target["이름"], json.encode(target), DEFAULT_LORE_OPTION)
    stateToVar(triggerId, "target", target)

    --갱신된 trace 정보를 변수에 업데이트
    stateToVar(triggerId, "targetTrace", traceCurrent)
    allTraces[target["이름"]] = traceCurrent
    setState(triggerId, "trace", allTraces)
    setChatVar(triggerId, "traceText", traceText)

    --조교 로그를 저장후 신규 챗 인덱스에 게임 화면 생성
    addChat(triggerId, "user", "{{".."getvar::html".."}}")
    local ampm = getChatVar(triggerId,"ampm")
    if ampm == "0" then ampm ="낮" else ampm="밤" end
    local lastTrainLog = "<div class='showLog' style='visibility: {{#when::showLog::vis::1}}visible{{:else}}hidden{{/when}};'><p>"..getChatVar(triggerId,"day").."일차 "..ampm.." / 조교 대상:"..target["이름"].."</p><p>"..getChatVar(triggerId,"oldLog")..getChatVar(triggerId,"newLog").."</p></div>"
    setChat(triggerId, getChatLength(triggerId)-2, lastTrainLog)

    --정보 초기화
    setChatVar(triggerId, "selectedAbl", "none")
    --조교후 화면으로 이동
    screenChange(triggerId, "ablUp")
end