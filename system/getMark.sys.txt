--[[
    ê°ì¸ íšë“ ì‹œìŠ¤í…œ (ë¦¬íŒ©í† ë§ ë²„ì „)
    ë°˜ë³µë˜ëŠ” ê°ì¸ ì²˜ë¦¬ ë¡œì§ì„ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ í†µí•©
]]
function (triggerId, stats, target)
    -- mark.db ì§ì ‘ ë¡œë“œ ì œê±°: ë‚´ë¶€ ì •ì˜ ì‚¬ìš©
    local EXPtbl = getDB(triggerId, "EXPtable.db")
    local target = target
    local stats = stats
    local markBase = 25 --ê°ì¸ íšë“ ë² ì´ìŠ¤ ìˆ˜ì¹˜
    local markSum = 0 --ëª¨ë“  ê°ì¸ì˜ í•©ê³„
    local screenEffect = ""

    --[[
        ê°ì¸ ì •ì˜ í…Œì´ë¸”
        name: ê°ì¸ëª…
        icon: ì´ëª¨ì§€ ì•„ì´ì½˜
        isNegative: ë„¤ê±°í‹°ë¸Œ ê°ì¸ ì—¬ë¶€ (ë°˜ë°œ, ê³ í†µ, ê³µí¬)
        calculator: maxP ê³„ì‚° í•¨ìˆ˜
    ]]
    local markDefinitions = {
        {
            name = "ë°˜ë°œê°ì¸",
            icon = "ğŸ’¢",
            isNegative = true,
            calculator = function(s)
                return math.max(s["ì €í•­"] or 0, ((s["ìˆ˜ì¹˜"] or 0) + (s["ê³ í†µ"] or 0) + (s["ë¶ˆì¾Œ"] or 0)) * 0.1 + (s["ì €í•­"] or 0) * 0.5)
            end
        },
        {
            name = "ê³ í†µê°ì¸",
            icon = "ğŸª±",
            isNegative = true,
            calculator = function(s)
                return math.max(s["ê³ í†µ"] or 0, ((s["ê³µí¬"] or 0) + (s["ë¶ˆì¾Œ"] or 0)) * 0.15 + (s["ê³ í†µ"] or 0) * 0.5)
            end
        },
        {
            name = "ê³µí¬ê°ì¸",
            icon = "ğŸ©»",
            isNegative = true,
            calculator = function(s)
                return math.max(s["ê³µí¬"] or 0, ((s["êµ´ë³µ"] or 0) + (s["ê³ í†µ"] or 0) + (s["ë¶ˆì¾Œ"] or 0)) * 0.1 + (s["ê³µí¬"] or 0) * 0.5)
            end
        },
        {
            name = "ë³µì¢…ê°ì¸",
            icon = "ğŸ™",
            isNegative = false,
            calculator = function(s)
                return math.max(s["ì˜¨ìˆœ"] or 0, ((s["ìš•ì •"] or 0) + (s["êµ´ë³µ"] or 0)) * 0.15 + (s["ì˜¨ìˆœ"] or 0) * 0.5)
            end
        },
        {
            name = "ì¹˜ìš•ê°ì¸",
            icon = "â›“ï¸â€ğŸ’¥",
            isNegative = false,
            calculator = function(s)
                return math.max(s["ìˆ˜ì¹˜"] or 0, (s["êµ´ë³µ"] or 0) * 0.4 + (s["ìˆ˜ì¹˜"] or 0) * 0.4)
            end
        },
        {
            name = "ì¾Œë½ê°ì¸",
            icon = "â­",
            isNegative = false,
            calculator = function(s)
                return math.max(
                    s["Cì¾Œë½"] or 0, s["Vì¾Œë½"] or 0, s["Bì¾Œë½"] or 0, s["Aì¾Œë½"] or 0, 
                    s["Uì¾Œë½"] or 0, s["Mì¾Œë½"] or 0, s["Sì¾Œë½"] or 0,
                    ((s["Cì¾Œë½"] or 0) + (s["Vì¾Œë½"] or 0) + (s["Bì¾Œë½"] or 0) + (s["Aì¾Œë½"] or 0)) * 0.2
                )
            end
        }
    }

    --ê°ì¸ë ˆë²¨ í•©ê³„ ë„ì¶œ (ì •ì˜ëœ ê°ì¸ ëª©ë¡ ê¸°ì¤€)
    for _, def in ipairs(markDefinitions) do
        if tonumber(target[def.name]) and tonumber(target[def.name]) > 0 then
            markSum = markSum + 1
        end
    end

    --[[
        ê°ì¸ ì²˜ë¦¬ í•¨ìˆ˜
        í•œ í„´ì— í•˜ë‚˜ì˜ ê°ì¸ë§Œ íšë“ ê°€ëŠ¥
    ]]
    local function processMark(markDef)
        local currentLevel = tonumber(target[markDef.name]) or 0
        if currentLevel >= 3 then
            return false --ì´ë¯¸ ìµœëŒ€ ë ˆë²¨
        end

        local maxP = markDef.calculator(stats)
        local cssClass = "neggative" -- CSS í´ë˜ìŠ¤ í†µì¼ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)

        --ë ˆë²¨ì—… íŒì • (í•œë²ˆì— ìµœëŒ€ 3ê¹Œì§€ ê°€ëŠ¥)
        local newLevel = currentLevel
        -- EXPtbl í‚¤ê°€ ë¬¸ìì—´ì¸ì§€ ìˆ«ìì¸ì§€ í™•ì¸ í•„ìš”í•˜ë‚˜ ì¼ë‹¨ tostring ìœ ì§€
        local threshold2 = markBase * (EXPtbl[tostring(markSum + 2)] or 99999)
        local threshold1 = markBase * (EXPtbl[tostring(markSum + 1)] or 99999)
        local threshold0 = markBase * (EXPtbl[tostring(markSum)] or 99999)

        if maxP > threshold2 then
            newLevel = 3
        elseif maxP > threshold1 then
            newLevel = math.min(currentLevel + 2, 3)
        elseif maxP > threshold0 then
            newLevel = currentLevel + 1
        end

        if newLevel > currentLevel then
            target[markDef.name] = tostring(newLevel)
            screenEffect = "<div class='getMark'><div class='getMarkText " .. cssClass .. "'>" ..
                markDef.icon .. " " .. markDef.name .. " Lv." .. newLevel .. " íšë“!!</div></div>"
            return true --ê°ì¸ íšë“ ì„±ê³µ
        end

        return false
    end

    --ëª¨ë“  ê°ì¸ì— ëŒ€í•´ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬
    for _, markDef in ipairs(markDefinitions) do
        if processMark(markDef) then
            return target, screenEffect --í•˜ë‚˜ì˜ ê°ì¸ì„ ì–»ìœ¼ë©´ ë‹¤ë¥¸ ê°ì¸ì€ ì–»ì„ ìˆ˜ ì—†ìŒ
        end
    end

    return target, screenEffect
end