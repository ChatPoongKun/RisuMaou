(function()
    local funcs = {}

    -- 기존 로직을 select 함수로 이동
    function funcs.select(triggerId, category, name)
        -- 카테고리에 맞는 DB 파일 매핑
        local dbMap = {
            ["abl"] = "abl.db",
            ["mark"] = "mark.db",
            ["trace"] = "trace.db",
            ["exp"] = "exp.db",
            ["stat"] = "stat.db",
            ["trait"] = "trait.db",
            ["item"] = "items.db",
            ["monster"] = "monsters.db"
        }
        
        local dbName = dbMap[category] or category..".db"
        
        -- 아이템의 경우 trap.db도 검색해야 하므로 별도 처리
        local data = nil
        
        if category == "item" then
            local itemsDB = getDB(triggerId, "items.db")
            local trapDB = getDB(triggerId, "trap.db")
            
            -- items.db는 중첩 구조: itemsDB[카테고리][키]
            -- 모든 카테고리를 순회하여 키 검색
            for catName, items in pairs(itemsDB) do
                if type(items) == "table" and items[name] then
                    data = items[name]
                    break
                end
            end
            
            -- items.db에서 못 찾으면 trap.db 검색
            if not data and trapDB[name] then 
                data = trapDB[name]
            end
            
        else
            local db = getDB(triggerId, dbName)
            if db then
                -- 1. 키로 직접 검색 시도
                if db[name] then
                    data = db[name]
                else
                    -- 2. 키 검색 실패 시, 이름(v.name)으로 검색 시도
                    for k, v in pairs(db) do
                        if v.name == name then
                            data = v
                            break
                        end
                    end
                end
            end
        end
        
        local title = name
        local desc = ""
    
        if data then
            title = data.name or name
            desc = data.desc or "설명이 없습니다."
            
            -- 추가 정보 표시
            if category == "monster" then
                local rating = data.rating or "?"
                local hp = data.hp or "?"
                local atkMin = data.atkMin or "?"
                local atkMax = data.atkMax or "?"
                local def = data.def or "?"
                
                desc = desc .. "<br><br>" ..
                       "Rating: " .. rating .. " | HP: " .. hp .. "<br>" ..
                       "ATK: " .. atkMin .. "~" .. atkMax .. " | DEF: " .. def
            end
    
            if (category == "item") and data.price then
                 desc = desc .. "<br>가격: " .. data.price .. " Spirit"
            end
    
        else
            desc = "정보를 찾을 수 없습니다."
        end
        
        setChatVar(triggerId, "dictTitle", title)
        setChatVar(triggerId, "dictDesc", desc)
    end

    -- 버튼 클릭 핸들러
    -- data format: "dictSelect.sys_category_name"
    function funcs.click(triggerId, data)
        local category, name = string.match(data, "dictSelect%.sys_([^_]+)_(.*)")
        if category and name then
            funcs.select(triggerId, category, name)
        else
            debug("dictSelect.sys: 잘못된 데이터 포맷 - " .. tostring(data))
        end
    end

    return function(triggerId, subFunc, ...)
        if funcs[subFunc] then
            return funcs[subFunc](triggerId, ...)
        else
            debug("dictSelect.sys: 알 수 없는 함수 - " .. tostring(subFunc))
        end
    end
end)()